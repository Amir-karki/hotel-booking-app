@model ProfileViewModel
@{
    ViewData["Title"] = "My Profile";
}

<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-body">
                    <h1 class="mb-4">My Profile</h1>

                    <form asp-action="Index" method="post" enctype="multipart/form-data" id="profileForm">
                        <div asp-validation-summary="ModelOnly" class="alert alert-danger"></div>

                        <div class="text-center mb-4">
                            <div class="profile-picture-container">
                                @if (!string.IsNullOrEmpty(Model.CurrentProfilePictureUrl))
                                {
                                    <img src="@Model.CurrentProfilePictureUrl"
                                         alt="Profile Picture"
                                         class="profile-picture-large"
                                         id="currentProfilePicture"
                                         onerror="this.src='https://ui-avatars.com/api/?name=@(Model.FirstName)+@(Model.LastName)&size=150&background=2563eb&color=fff'" />
                                }
                                else
                                {
                                    <div class="profile-picture-placeholder" id="currentProfilePicture">
                                        <span>@(Model.FirstName?.Substring(0, 1) ?? "U")@(Model.LastName?.Substring(0, 1) ?? "")</span>
                                    </div>
                                }

                                <div class="profile-picture-preview-container" id="previewContainer" style="display: none;">
                                    <img id="imagePreview" class="profile-picture-large" alt="Preview" />
                                </div>
                            </div>

                            <div class="mt-3">
                                <input type="file"
                                       asp-for="ProfilePicture"
                                       id="profilePictureInput"
                                       accept="image/jpeg,image/jpg,image/png,image/gif"
                                       style="display: none;" />
                                <button type="button" class="btn btn-pill btn-outline" id="selectImageBtn">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 0.5rem;">
                                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                        <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                        <polyline points="21 15 16 10 5 21"></polyline>
                                    </svg>
                                    Choose Profile Picture
                                </button>
                                <span asp-validation-for="ProfilePicture" class="text-danger d-block mt-2"></span>
                                <small class="form-text text-muted">JPG, PNG, or GIF (max 5MB)</small>
                            </div>

                            <div id="uploadConfirmation" class="mt-3" style="display: none;">
                                <div class="alert alert-info">
                                    <p class="mb-2"><strong>New image selected!</strong></p>
                                    <p class="mb-0" id="selectedFileName"></p>
                                </div>
                                <div class="d-flex gap-2 justify-content-center">
                                    <button type="button" class="btn btn-sm btn-pill btn-danger" id="cancelImageBtn">
                                        Cancel
                                    </button>
                                    <span class="text-muted">Preview shown above. Click "Save Changes" below to upload.</span>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="FirstName" class="form-label"></label>
                                <input asp-for="FirstName" class="form-control" />
                                <span asp-validation-for="FirstName" class="text-danger"></span>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label asp-for="LastName" class="form-label"></label>
                                <input asp-for="LastName" class="form-control" />
                                <span asp-validation-for="LastName" class="text-danger"></span>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label asp-for="Email" class="form-label"></label>
                            <input asp-for="Email" type="email" class="form-control" />
                            <span asp-validation-for="Email" class="text-danger"></span>
                        </div>

                        <div class="mb-3">
                            <label asp-for="PhoneNumber" class="form-label"></label>
                            <input asp-for="PhoneNumber" type="tel" class="form-control" />
                            <span asp-validation-for="PhoneNumber" class="text-danger"></span>
                        </div>

                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-pill btn-primary">Save Changes</button>
                            <a asp-controller="Home" asp-action="Index" class="btn btn-pill btn-outline">Cancel</a>
                        </div>
                    </form>
                </div>
            </div>

            <div class="card mt-4">
                <div class="card-body">
                    <h3 class="mb-3">Quick Stats</h3>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="stat-item">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect>
                                    <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path>
                                </svg>
                                <div>
                                    <div class="stat-label">Bookings</div>
                                    <a asp-controller="Booking" asp-action="MyBookings" class="stat-link">View Your Bookings</a>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="stat-item">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                                </svg>
                                <div>
                                    <div class="stat-label">Browse</div>
                                    <a asp-controller="Home" asp-action="Index" class="stat-link">Find Hotels</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const selectImageBtn = document.getElementById('selectImageBtn');
            const profilePictureInput = document.getElementById('profilePictureInput');
            const imagePreview = document.getElementById('imagePreview');
            const previewContainer = document.getElementById('previewContainer');
            const currentProfilePicture = document.getElementById('currentProfilePicture');
            const uploadConfirmation = document.getElementById('uploadConfirmation');
            const selectedFileName = document.getElementById('selectedFileName');
            const cancelImageBtn = document.getElementById('cancelImageBtn');

            // Open file browser when button is clicked
            selectImageBtn.addEventListener('click', function() {
                profilePictureInput.click();
            });

            // Handle file selection
            profilePictureInput.addEventListener('change', function(e) {
                const file = e.target.files[0];

                if (file) {
                    // Validate file type
                    const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
                    if (!allowedTypes.includes(file.type)) {
                        alert('Please select a valid image file (JPG, PNG, or GIF)');
                        profilePictureInput.value = '';
                        return;
                    }

                    // Validate file size (5MB)
                    if (file.size > 5 * 1024 * 1024) {
                        alert('File size must not exceed 5MB');
                        profilePictureInput.value = '';
                        return;
                    }

                    // Show preview
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        imagePreview.src = e.target.result;

                        // Hide current picture, show preview
                        currentProfilePicture.style.display = 'none';
                        previewContainer.style.display = 'block';
                        uploadConfirmation.style.display = 'block';

                        // Show file name
                        selectedFileName.textContent = `File: ${file.name} (${(file.size / 1024).toFixed(2)} KB)`;
                    };
                    reader.readAsDataURL(file);
                }
            });

            // Handle cancel
            cancelImageBtn.addEventListener('click', function() {
                // Clear file input
                profilePictureInput.value = '';

                // Hide preview, show current picture
                previewContainer.style.display = 'none';
                currentProfilePicture.style.display = 'block';
                uploadConfirmation.style.display = 'none';
            });
        });
    </script>
}
